<!DOCTYPE html>
<html>
<head>
    <title>Home Feed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- GLOBAL ANIMATIONS & THEME --- */
        body { 
            background-color: #050505; 
            color: #e0e0e0; 
            font-family: 'Segoe UI', sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
        }

        /* Smooth Fade In */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Header Styling */
        .header-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding-bottom: 20px; 
            margin-bottom: 20px; 
            border-bottom: 1px solid #333;
        }

        .logo { color: #ff1493; font-weight: bold; font-size: 1.5em; text-decoration: none; text-shadow: 0 0 10px #ff1493; }

        /* Search Bar */
        .search-box {
            background: #111; border: 1px solid #333; padding: 8px 15px; border-radius: 20px; color: white; outline: none; transition: 0.3s;
        }
        .search-box:focus { border-color: #ff1493; box-shadow: 0 0 10px rgba(255, 20, 147, 0.3); }

        /* Post Box */
        .post-box { 
            background: #111; 
            padding: 20px; 
            border-radius: 15px; 
            border: 1px solid #222; 
            margin-bottom: 20px; 
            transition: transform 0.2s;
        }
        .post-box:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        /* Profile Icons */
        .avatar-small { 
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #ff1493; vertical-align: middle; margin-right: 10px;
        }
        
        /* Buttons */
        .btn { 
            background: linear-gradient(45deg, #ff1493, #d60076); 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: 0.3s;
        }
        .btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 20, 147, 0.6); }

        .like-btn { background:none; border:none; cursor:pointer; font-size:1.2em; color:#ff1493; transition: transform 0.2s; }
        .like-btn:active { transform: scale(1.4); }

        /* Delete Button */
        .delete-btn { color: #666; font-size: 0.9em; cursor: pointer; transition: 0.2s; }
        .delete-btn:hover { color: #ff4444; }
    </style>
</head>
<body>

    <div class="header-bar fade-in">
        <a href="{% url 'home' %}" class="logo"><i class="fas fa-bolt"></i> SOCIAL APP</a>
        
        <form action="{% url 'search_users' %}" method="GET">
            <input type="text" name="q" class="search-box" placeholder="üîç Search User...">
        </form>

        <div style="display:flex; align-items:center; gap:20px;">
            
            <a href="{% url 'inbox' %}" title="Messages" style="color:white; font-size:1.4em; position:relative;">
                <i class="fas fa-comment-dots"></i>
            </a>

            <a href="{% url 'profile' user.username %}" title="Profile">
                {% if user.profile.profile_pic %}
                    <img src="{{ user.profile.profile_pic.url }}" class="avatar-small" style="width:35px; height:35px;">
                {% else %}
                    <i class="fas fa-user-circle" style="font-size:35px; color:#ff1493;"></i>
                {% endif %}
            </a>

            <form action="{% url 'logout' %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" title="Logout" style="background:none; border:none; color:#666; cursor:pointer; font-size:1.2em;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </form>
        </div>
    </div>

    <div class="post-box fade-in">
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <textarea name="content" style="width:100%; background:#000; border:none; color:white; resize:none; outline:none; font-family:inherit;" placeholder="What's happening?"></textarea>
            
            <img id="image-preview" style="max-width:100%; border-radius:10px; margin-top:10px; display:none;">

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; border-top:1px solid #222; padding-top:10px;">
                <div style="color:#ff1493;">
                    <label style="cursor:pointer; margin-right:15px;" title="Upload Photo"><i class="fas fa-image"></i> <input type="file" name="image" style="display:none;" onchange="previewImage(event)"></label>
                    <label style="cursor:pointer;" title="Upload Video"><i class="fas fa-video"></i> <input type="file" name="video" style="display:none;"></label>
                </div>
                <button type="submit" class="btn">Post</button>
            </div>
        </form>
    </div>

    {% for post in posts %}
        <div class="post-box fade-in">
            
            <div style="margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;">
                <a href="{% url 'profile' post.user.username %}" style="text-decoration:none; color:white; display:flex; align-items:center;">
                    {% if post.user.profile.profile_pic %}
                        <img src="{{ post.user.profile.profile_pic.url }}" class="avatar-small">
                    {% else %}
                        <i class="fas fa-user-circle" style="font-size:40px; color:#333; margin-right:10px;"></i>
                    {% endif %}
                    <div>
                        <span style="font-weight:bold; display:block;">@{{ post.user.username }}</span>
                        <span style="color:#666; font-size:0.8em;">{{ post.created_at|date:"M d" }}</span>
                    </div>
                </a>

                {% if request.user == post.user %}
                    <a href="{% url 'delete_post' post.id %}" onclick="return confirm('Are you sure you want to delete this post?');" class="delete-btn" title="Delete Post">
                        <i class="fas fa-trash-alt"></i>
                    </a>
                {% endif %}
            </div>

            <p style="font-size:1.1em; line-height:1.5;">{{ post.content }}</p>

            {% if post.image %}
                <img src="{{ post.image.url }}" style="width:100%; border-radius:10px; margin-top:10px; border:1px solid #222;">
            {% endif %}

            {% if post.video %}
                <video src="{{ post.video.url }}" controls style="width:100%; border-radius:10px; margin-top:10px; border:1px solid #222;"></video>
            {% endif %}

            <div style="margin-top:15px; display:flex; gap:20px; border-top:1px solid #222; padding-top:10px;">
                
                <button class="like-btn" onclick="toggleLike({{ post.id }})">
                    <span id="heart-{{ post.id }}">{% if request.user in post.likes.all %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span> 
                    <span id="count-{{ post.id }}" style="font-size:0.8em; color:#888;">{{ post.total_likes }}</span>
                </button>
                
                <button class="like-btn" style="color:#ccc;"><i class="far fa-comment"></i> <span style="font-size:0.8em;">{{ post.comments.count }}</span></button>
            </div>

            <div style="background:#000; padding:10px; margin-top:10px; border-radius:5px;">
                {% for comment in post.comments.all %}
                    <div style="font-size:0.9em; margin-bottom:5px;">
                        <span style="color:#ff1493; font-weight:bold;">{{ comment.user.username }}:</span> {{ comment.text }}
                    </div>
                {% endfor %}
                <form action="{% url 'add_comment' post.id %}" method="POST" style="margin-top:10px; display:flex;">
                    {% csrf_token %}
                    <input type="text" name="text" placeholder="Write a comment..." style="background:#111; border:1px solid #333; color:white; flex-grow:1; padding:8px; border-radius:20px; outline:none;">
                    <button style="background:none; color:#ff1493; border:none; cursor:pointer; margin-left:5px;">Reply</button>
                </form>
            </div>
        </div>
    {% endfor %}

    <script>
        function previewImage(event) {
            var reader = new FileReader();
            reader.onload = function(){
                var output = document.getElementById('image-preview');
                output.src = reader.result;
                output.style.display = 'block';
            };
            reader.readAsDataURL(event.target.files[0]);
        }

        function toggleLike(postId) {
            fetch(`/api/like/${postId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById(`heart-${postId}`).innerHTML = data.liked ? "‚ù§Ô∏è" : "ü§ç";
                document.getElementById(`count-${postId}`).innerHTML = data.count;
            });
        }
    </script>

</body>
</html>